# osu!风格谱面生成器后续开发计划

## 文档信息
- **文档版本**：1.1
- **创建日期**：2023-03-14
- **更新日期**：2023-03-14
- **状态**：开发进行中
- **适用对象**：开发团队、项目管理人员

## 目录
1. [项目概述](#项目概述)
2. [当前状态评估](#当前状态评估)
3. [后续开发流程](#后续开发流程)
4. [实施计划与时间线](#实施计划与时间线)
5. [资源需求](#资源需求)
6. [风险评估与缓解策略](#风险评估与缓解策略)
7. [验收标准](#验收标准)
8. [附录：技术规范与示例](#附录技术规范与示例)

## 项目概述

osu!风格谱面生成器是一个基于深度学习的音乐游戏谱面自动生成系统，旨在通过分析音频特征，生成符合osu!游戏规则和节奏感的谱面文件。项目包含GUI界面、音频分析、谱面分析、模型训练与谱面生成等模块，为音乐游戏爱好者提供自动化谱面创作工具。

### 主要功能

- 音频分析：提取BPM、节拍、频谱等音频特征
- 谱面生成：基于音频特征生成符合游戏规则的谱面
- 模型训练：支持使用已有谱面数据训练生成模型
- 可视化界面：提供用户友好的操作界面和结果预览
- 难度调整：支持多种难度级别的谱面生成

## 当前状态评估

### 已完成模块

1. **GUI前端框架**：✅
   - 主窗口界面搭建与基本样式设置
   - 多个功能选项卡（音频分析、谱面分析、数据集处理、模型训练）
   - 基本交互功能实现，包括文件选择、参数设置
   - 训练界面与GPU选项

2. **音频分析模块**：✅
   - 音频文件加载与处理
   - BPM与节拍检测算法
   - 频谱特征提取
   - 音频可视化功能
   - 音频高级特征分析（节拍强度、段落检测等）

3. **谱面分析模块**：✅
   - OSU文件格式解析器
   - 谱面物件统计与分布分析
   - 节奏密度分析
   - 谱面模式识别
   - 谱面可视化（热图、时间分布等）

### 部分完成模块

1. **数据处理模块**：⚠️
   - 目录结构已创建
   - 部分数据处理逻辑在GUI中已实现
   - 需要完善数据集构建和特征提取功能

2. **模型训练流程**：🔄
   - 训练线程框架已在GUI中实现
   - 支持GPU设置与训练控制
   - 尚未实现具体的模型结构与训练逻辑

### 待完成模块

1. **模型架构设计与实现**：❌
   - 模型目录结构已创建但为空
   - 需要实现Transformer模型架构
   - 需要设计损失函数和评估指标

2. **谱面生成模块**：❌
   - 核心生成算法尚未实现
   - 规则约束系统尚未开发
   - 难度调整功能未实现

3. **系统集成与优化**：❌
   - 模块间完整集成
   - 性能优化
   - 打包与部署

## 后续开发流程

### 一、模型架构实现（⚠️ 高优先级，预计2周）

#### 1. 模型结构设计
- **设计Transformer架构**：实现用于时序生成的Transformer模型
- **特征编码器设计**：开发音频特征到模型输入的编码器
- **谱面解码器设计**：实现从模型输出到谱面参数的解码器

#### 2. 损失函数设计
- **自定义损失函数**：结合MSE损失和节奏相关损失
- **加权损失组合**：平衡不同类型谱面元素的重要性
- **实现节奏一致性约束**：确保生成的谱面遵循音乐节奏

#### 3. 模型评估机制
- **设计评估指标**：谱面质量、节奏一致性、难度准确性等
- **验证流程**：实现模型验证与评估流程
- **可视化评估结果**：提供训练过程和结果的可视化

#### 技术规范
- 模型架构：Transformer编码器-解码器，4-6层，8个注意力头
- 训练框架：PyTorch 2.0+
- GPU支持：CUDA 11.0+，支持混合精度训练
- 训练配置：批次大小16-32，学习率0.0001-0.001，训练周期50-100

### 二、数据处理模块完善（预计1.5周）

#### 1. 数据集构建
- **完善数据集类**：实现数据集加载与管理功能
- **特征提取管道**：完成从原始音频和谱面到训练数据的转换
- **数据集分割**：训练集、验证集和测试集划分逻辑

#### 2. 特征工程
- **补充音频特征**：优化并补充更多特征提取算法
- **特征归一化**：实现特征标准化和归一化处理
- **数据增强技术**：添加数据增强方法提高模型泛化能力

#### 3. 数据集管理工具
- **完善GUI数据集管理功能**：优化现有的数据集处理界面
- **批量处理功能**：添加批量特征提取和预处理功能
- **数据集质量评估**：添加数据质量检查工具

#### 技术规范
- 数据集格式：HDF5或JSON格式，包含音频特征和谱面标签
- 音频特征：MFCC、频谱图、节拍特征等，采样率22050Hz
- 谱面标签：物件类型、位置、时间等，按时间戳对齐

### 三、模型训练模块实现（预计2周）

#### 1. 完善训练流程
- **实现训练循环**：完善现有GUI中的训练线程
- **优化器配置**：实现合适的优化器和学习率调度
- **训练状态管理**：添加检查点保存和恢复功能
- **训练监控**：完善训练过程可视化和日志

#### 2. 集成GPU加速
- **完善GPU支持**：优化现有的GPU配置选项
- **混合精度训练**：实现适配不同硬件的混合精度训练
- **多卡训练支持**：添加对多GPU训练的支持

#### 3. 超参数优化
- **网格搜索工具**：实现超参数搜索功能
- **超参数存储**：保存和加载超参数配置
- **优化建议**：基于硬件和数据集提供训练参数建议

#### 技术规范
- 训练框架：PyTorch DataLoader + Trainer类
- 混合精度：torch.cuda.amp
- 检查点：每轮保存，支持最佳模型保存
- 学习率：余弦退火调度

### 四、谱面生成模块实现（预计2周）

#### 1. 生成算法实现
- **谱面构建器**：实现从模型输出到谱面对象的转换
- **规则检查器**：确保生成的谱面符合osu!规则
- **后处理优化**：实现谱面流畅性和可玩性优化

#### 2. 难度调整系统
- **难度缩放器**：实现不同难度等级的谱面生成
- **风格适配**：为不同音乐类型提供适当的谱面风格
- **用户偏好记忆**：学习和记录用户的谱面调整

#### 3. 谱面预览与编辑
- **预览可视化**：实现谱面生成前的预览功能
- **编辑界面**：添加生成后的谱面编辑功能
- **批量生成**：支持多难度谱面的批量生成

#### 技术规范
- 谱面格式：兼容osu!标准格式(v14)
- 物件类型：支持圆圈、滑条、转盘等所有osu!物件
- 难度级别：Easy、Normal、Hard、Expert四个级别
- 预览方式：2D可视化，支持播放音频同步预览

### 五、用户界面优化（预计1周）

#### 1. GUI美化
- **界面设计改进**：优化现有的界面布局和样式
- **交互体验优化**：改进操作流程和响应速度
- **错误处理增强**：完善错误消息和处理机制

#### 2. 用户设置系统
- **配置保存与加载**：实现用户设置的保存和恢复
- **主题切换**：添加深色模式和自定义主题
- **偏好设置**：增加更多自定义选项

#### 3. 功能整合与优化
- **模块间导航优化**：改进不同功能模块间的交互
- **工作流程简化**：优化从音频分析到谱面生成的工作流
- **批处理支持**：添加批量处理音频和生成谱面的功能

#### 技术规范
- GUI框架：继续使用PyQt5
- 设计语言：遵循现代扁平化设计
- 性能目标：界面响应时间<100ms
- 兼容性：确保Windows 10+和macOS支持

### 六、测试与优化（预计1.5周）

#### 1. 单元测试
- **核心模块测试**：为关键功能模块编写单元测试
- **集成测试**：测试模块间集成功能
- **自动化测试脚本**：实现自动化测试流程

#### 2. 性能优化
- **性能分析**：识别和解决性能瓶颈
- **内存优化**：减少大规模数据处理的内存消耗
- **推理加速**：优化模型推理速度

#### 3. 用户测试
- **内部测试**：团队内部功能和体验测试
- **beta测试计划**：准备有限用户的beta测试
- **反馈收集机制**：建立用户反馈渠道

#### 技术规范
- 测试框架：pytest
- 性能目标：生成一张谱面时间<10秒(CPU)/<2秒(GPU)
- 内存占用：运行时内存峰值<4GB
- 测试覆盖率：核心功能>80%

### 七、打包与发布（预计1周）

#### 1. 应用打包优化
- **完善PyInstaller配置**：优化现有的打包配置
- **减小安装包体积**：优化依赖和资源包含
- **跨平台兼容性**：确保在主要操作系统上的运行

#### 2. 文档完善
- **用户手册更新**：创建详细的用户指南
- **开发文档整理**：完善代码文档和API说明
- **示例和教程**：添加应用使用示例和教程

#### 3. 发布准备
- **版本规划**：确定版本号和更新日志
- **发布渠道**：准备GitHub发布和官网下载
- **宣传计划**：在相关社区宣传发布

#### 技术规范
- 打包工具：PyInstaller 5.11+
- 文档格式：Markdown和HTML
- 版本号规范：遵循语义化版本(Semantic Versioning)
- 发布渠道：GitHub Releases, 项目官网

## 实施计划与时间线

| 阶段 | 时间估计 | 开始日期 | 结束日期 | 主要里程碑 | 负责人 | 状态 |
|------|----------|----------|----------|------------|--------|------|
| GUI前端框架 | 3周 | 2023-02-20 | 2023-03-13 | 完整GUI界面，交互功能 | 前端开发者 | ✅ 已完成 |
| 音频分析模块 | 2周 | 2023-02-20 | 2023-03-06 | 音频特征提取，可视化功能 | 音频工程师 | ✅ 已完成 |
| 谱面分析模块 | 2周 | 2023-02-27 | 2023-03-13 | 谱面解析，分析功能 | 谱面工程师 | ✅ 已完成 |
| 模型架构实现 | 2周 | 2023-03-20 | 2023-04-02 | 完整模型架构，损失函数 | 机器学习工程师 | 📅 计划中 |
| 数据处理模块完善 | 1.5周 | 2023-03-20 | 2023-03-31 | 数据集构建，特征工程 | 数据工程师 | 📅 计划中 |
| 模型训练模块实现 | 2周 | 2023-04-03 | 2023-04-16 | 训练流程，GPU加速 | 机器学习工程师 | 📅 计划中 |
| 谱面生成模块实现 | 2周 | 2023-04-17 | 2023-04-30 | 生成算法，难度调整 | 算法工程师 | 📅 计划中 |
| 用户界面优化 | 1周 | 2023-05-01 | 2023-05-07 | 界面美化，用户设置 | 前端开发者 | 📅 计划中 |
| 测试与优化 | 1.5周 | 2023-05-08 | 2023-05-19 | 测试报告，性能优化 | QA团队 | 📅 计划中 |
| 打包与发布 | 1周 | 2023-05-22 | 2023-05-28 | 安装包，文档，发布 | 项目经理 | 📅 计划中 |

**总计**：约16周（2023-02-20至2023-05-28）
**当前进度**：约25%（已完成GUI、音频分析和谱面分析模块的开发）

### 进度评审计划
- 每周一进行团队内部进度评审
- 每个阶段结束时进行里程碑评审
- 在模型训练和谱面生成阶段中点进行技术评审

## 资源需求

### 硬件需求
- **开发环境**：
  - CPU: 4核心8线程以上
  - 内存: 16GB以上
  - GPU: NVIDIA GTX 1060 6GB或更高(用于模型训练)
  - 存储: 100GB以上SSD

- **训练环境**：
  - GPU: NVIDIA RTX 2070或更高(最好有8GB+显存)
  - 内存: 32GB以上
  - 存储: 500GB以上SSD(用于数据集和模型存储)

### 软件需求
- **开发工具**：
  - IDE: PyCharm, VSCode
  - 版本控制: Git
  - 项目管理: GitHub Projects或Trello

- **依赖库**：
  - PyTorch 2.0+
  - librosa 0.10.0+
  - PyQt5 5.15+
  - numpy 1.22+
  - matplotlib 3.7+
  - soundfile 0.12+
  - transformers 4.29+

### 人力资源
- 数据工程师: 1人
- 机器学习工程师: 1-2人
- 算法工程师: 1人
- 前端开发者: 1人
- QA工程师: 1人
- 项目经理: 1人(可兼任)

## 风险评估与缓解策略

| 风险 | 影响 | 可能性 | 缓解策略 | 更新状态 |
|------|------|--------|----------|----------|
| 音频分析不准确 | 高 | 中 | 结合多种算法，针对不同音乐类型开发专门的分析方法 | ✓ 已实现多种分析算法 |
| 训练数据不足 | 高 | 高 | 实现数据增强技术，开发自动抓取工具，考虑半监督学习方法 | ⚠️ 尚未解决，高优先级 |
| 模型泛化能力不足 | 中 | 中 | 使用更多样化的训练数据，实现正则化技术，增加验证测试 | 🔄 正在制定解决方案 |
| 生成谱面不符合游戏规则 | 高 | 低 | 实现严格的后处理规则检查，加入专家知识约束 | 🔄 已在设计阶段 |
| 性能问题 | 中 | 中 | 实现模型量化，优化推理过程，使用异步处理 | 🔄 部分优化已实现 |
| 依赖库兼容性问题 | 中 | 中 | 固定依赖版本，全面测试，提供虚拟环境配置 | ✓ 已固定依赖版本 |
| 用户体验不佳 | 高 | 低 | 早期进行用户测试，迭代改进界面，提供详细教程 | 🔄 初步界面已完成，待优化 |

## 验收标准

### 功能验收标准
1. **数据处理模块**：
   - 能够成功提取95%以上测试音频的BPM和节拍
   - 构建的数据集大小≥1000个音频-谱面对
   - 数据预处理流程处理速度≥10个样本/秒

2. **模型训练模块**：
   - 训练损失能够收敛且验证损失稳定
   - 训练速度≥100个样本/秒(使用GPU)
   - 模型大小≤500MB
   - 支持保存/加载模型权重和训练状态

3. **谱面生成模块**：
   - 生成的谱面100%符合osu!格式规范
   - 95%以上的生成谱面能在游戏中正常加载和播放
   - 生成的谱面与音乐节奏匹配度≥80%(主观评估)
   - 支持4种难度级别的谱面生成

4. **用户界面**：
   - 所有主要功能可通过界面访问
   - 操作响应时间<100ms
   - 界面布局适应不同屏幕分辨率
   - 提供清晰的状态反馈和进度指示

### 性能验收标准
- 应用启动时间≤5秒
- 音频分析时间≤音频长度的50%
- 模型推理时间≤10秒/谱面(CPU)或≤2秒/谱面(GPU)
- 内存峰值使用≤4GB
- 安装包大小≤1GB

### 文档验收标准
- 提供完整的用户手册，覆盖所有功能
- 提供开发文档，包含架构说明和API参考
- 提供至少3个使用示例和教程
- 代码注释覆盖率≥70%

## 附录：技术规范与示例

### 数据集结构示例
```python
class BeatmapDataset(torch.utils.data.Dataset):
    def __init__(self, data_dir, transform=None):
        self.data_dir = data_dir
        self.transform = transform
        self.samples = self._load_samples()
        
    def _load_samples(self):
        # 加载数据集索引
        samples = []
        # 遍历目录，找到配对的音频和谱面文件
        return samples
        
    def __len__(self):
        return len(self.samples)
        
    def __getitem__(self, idx):
        # 加载音频特征和谱面标签
        audio_path, beatmap_path = self.samples[idx]
        # 处理音频特征
        # 处理谱面标签
        return {'audio_features': features, 'beatmap_patterns': patterns}
```

### 模型架构示例
```python
class BeatmapTransformerV2(nn.Module):
    def __init__(self, input_dim=128, hidden_dim=256, output_dim=64, 
                num_layers=4, nhead=8, dropout=0.1):
        super().__init__()
        self.input_encoder = nn.Sequential(
            nn.Linear(input_dim, hidden_dim),
            nn.LayerNorm(hidden_dim),
            nn.Dropout(dropout),
            nn.ReLU()
        )
        encoder_layer = nn.TransformerEncoderLayer(
            d_model=hidden_dim, nhead=nhead, 
            dropout=dropout, batch_first=True
        )
        self.transformer_encoder = nn.TransformerEncoder(
            encoder_layer, num_layers=num_layers
        )
        self.output_decoder = nn.Sequential(
            nn.Linear(hidden_dim, hidden_dim//2),
            nn.ReLU(),
            nn.Dropout(dropout),
            nn.Linear(hidden_dim//2, output_dim)
        )
        
    def forward(self, x, src_mask=None, src_key_padding_mask=None):
        x = self.input_encoder(x)
        x = self.transformer_encoder(x, src_mask=src_mask, 
                                   src_key_padding_mask=src_key_padding_mask)
        return self.output_decoder(x)
```

### 训练配置示例
```python
# 训练配置
config = {
    # 数据配置
    'train_data_path': 'data/beatmaps/train',
    'val_data_path': 'data/beatmaps/val',
    'num_workers': 4,
    
    # 模型配置
    'model_name': 'transformer_v2',
    'input_dim': 128,
    'hidden_dim': 256,
    'output_dim': 64,
    'num_layers': 4,
    'nhead': 8,
    'dropout': 0.1,
    
    # 训练配置
    'batch_size': 16,
    'learning_rate': 0.001,
    'weight_decay': 1e-5,
    'epochs': 50,
    'clip_grad_norm': True,
    'max_grad_norm': 1.0,
    'log_interval': 10,
    
    # 优化配置
    'use_gpu': True,
    'use_mixed_precision': True,
    'use_validation': True,
    'save_checkpoint': True,
    'checkpoint_interval': 5,
    
    # 路径配置
    'model_dir': 'models/saved',
    'log_dir': 'logs'
}
```

---

**文档更新记录**

| 版本 | 日期 | 描述 | 更新人 |
|------|------|------|--------|
| 1.0 | 2023-03-14 | 初始文档创建 | 项目经理 |
| 1.1 | 2023-03-14 | 更新当前项目状态和调整开发计划 | 项目经理 |

注：本文档详细规划了项目的后续开发流程，包括各模块的具体任务、技术规范、时间线和资源需求。在实际执行过程中，可能需要根据实际情况进行调整。项目团队应定期回顾和更新本计划，确保开发按预期进行。 